name: CI/CD Pipeline with Keploy API Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  MONGODB_VERSION: '6.0'

jobs:
  # Lint and build job
  lint-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linting
      run: npm run lint
    
    - name: Build application
      run: npm run build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: .next/
        retention-days: 1

  # Unit tests job
  unit-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install main dependencies
      run: npm ci
    
    - name: Install test dependencies
      working-directory: ./tests
      run: npm ci
    
    - name: Run unit tests
      run: npm test
    
    - name: Upload test coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./tests/coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  # API Testing with Keploy job
  api-testing:
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install test dependencies
      working-directory: ./tests
      run: npm ci
    
    - name: Build application
      run: npm run build
    
    - name: Install Keploy CLI
      run: |
        curl --silent -L https://keploy.io/ent/install.sh | bash
    
    - name: Start MongoDB and wait for it to be ready
      run: |
        echo "Waiting for MongoDB to be ready..."
        timeout 60 bash -c 'until mongosh --eval "db.runCommand({ping: 1})" > /dev/null 2>&1; do sleep 2; done'
        echo "MongoDB is ready!"
    
    - name: Start application in background
      run: |
        export MONGODB_URI=mongodb://localhost:27017/task-management-test
        export NODE_ENV=test
        npm run dev &
        echo $! > app.pid
        sleep 15  # Wait for app to start
        
        # Check if app is running
        if curl -f http://localhost:3000/api/tasks > /dev/null 2>&1; then
          echo "Application is running successfully"
        else
          echo "Application failed to start"
          exit 1
        fi
    
    - name: Run Keploy Test Suite
      run: |
        export KEPLOY_API_KEY=${{ secrets.KEPLOY_API_KEY }}
        export KEPLOY_APP_ID=${{ secrets.KEPLOY_APP_ID }}
        export KEPLOY_BASE_PATH=${{ secrets.KEPLOY_BASE_PATH }}
        keploy test-suite --app=$KEPLOY_APP_ID --base-path $KEPLOY_BASE_PATH --cloud
    
    - name: Stop application
      if: always()
      run: |
        if [ -f app.pid ]; then
          kill $(cat app.pid) || true
          rm app.pid
        fi

  # Test summary job
  test-summary:
    runs-on: ubuntu-latest
    needs: [unit-tests, api-testing]
    if: always()
    
    steps:
    - name: Generate test summary
      run: |
        echo "## 🧪 Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Unit Tests" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### API Tests (Keploy Cloud)" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ${{ needs.api-testing.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Platform: Keploy AI API Testing Cloud" >> $GITHUB_STEP_SUMMARY
        echo "- Dashboard: https://app.keploy.io" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Overall Status" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.unit-tests.result }}" == "success" ] && [ "${{ needs.api-testing.result }}" == "success" ]; then
          echo "✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Some tests failed" >> $GITHUB_STEP_SUMMARY 